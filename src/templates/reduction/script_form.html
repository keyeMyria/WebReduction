 {% extends "base.html" %}
 
 {% load staticfiles %}

 {% load crispy_forms_tags %}
 
 {% block header %}
{{ block.super }}
<style type="text/css" media="screen">
    #editor {
		height: 600px;
		border-style: groove;
    }

    table.dataTable tbody tr.selected {
        background-color: #00451d !important;
    }
</style>

<link rel="stylesheet" type="text/css" href='{% static "thirdparty/DataTables/datatables.min.css" %}'>
<link rel="stylesheet" type="text/css" href='{% static "thirdparty/DataTables/Select-1.2.2/js/dataTables.select.min.js" %}'>

{% endblock %}

 
{% block breadcrumbs %}
<div class="container">
    <ol class="breadcrumb">
        <li><a href="{% url 'index' %}">Home</a></li>
        <li><a href="{% url 'reduction:list' %}">Reduction</a></li>
        <li class="active">{{object}}</li>
    </ol>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Reduction<small> script</small></h1>
    </div>

    <form method="post">

        {#% crispy form  %#}
        {% csrf_token %}

        {{ form.action|as_crispy_field }}

        <!-- Trigger the modal with a button -->
        <button id="button_pick_runs" type="button" class="btn btn-info"  onclick="showDataTable();">Pick Runs</button>


        <button id="button_generate" name="generate" type="submit" class="btn btn-primary" data-toggle="tooltip"
            data-placement="top" title="Did you do something wrong? This regenerate the script from the reduction fields."> Generate the script</button>

        {{ form.parameters|as_crispy_field }}
        {{ form.script|as_crispy_field }}

        <button id="button_save" name="save" type="submit" class="btn btn-primary" data-toggle="tooltip"
            data-placement="top" title="Save the script and go back to the detail.">Save &amp; go back</button>
        
        <button id="button_execute" name="execute" type="submit" class="btn btn-primary" data-toggle="tooltip"
            data-placement="top" title="Send the script to the cluster to be executed.">Execute</button>

        <button type="cancel" class="btn btn-default" onclick="window.history.back()">Cancel</button>
    </form>
</div>
<br/>




      
<!-- Modal for run picking-->
<div class="modal fade" id="runsModal" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Confirmation</h4>
            </div>
            <div class="modal-body">
                <table id="tableruns" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Run</th>
                            <th>Title</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                            <th>Run</th>
                            <th>Title</th>
                            <th>Location</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="selectRunsAll();">Select all</button>
                <button type="button" class="btn btn-info" onclick="selectRunsNone();">Select none</button>
                <button type="button" class="btn btn-primary" onclick="pickSelectedRuns();handleCompVisability();">Pick these runs</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block footer_js%}
{{ block.super }}
<script src='{% static "thirdparty/ace/ace.js" %}' type="text/javascript" charset="utf-8"></script>
<script src='{% static "thirdparty/ace/theme-github.js" %}' type="text/javascript" charset="utf-8"></script>
<script src='{% static "thirdparty/ace/mode-python.js" %}' type="text/javascript" charset="utf-8"></script>

<script src='{% static "thirdparty/DataTables/datatables.min.js" %}'></script>
<!-- <script src='{% static "thirdparty/DataTables/DataTables-1.10.15/js/jquery.dataTables.min.js" %}'></script> -->

<script>
    ///////////////////////////////////////////////////////////////////////////
	// set up Ace editor
	$('<div id="editor"></div>').insertBefore('#id_script');
	$('#id_script' ).css("display", "none")
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/github");
    editor.getSession().setMode("ace/mode/python");
    
    // set editor value to what I have in the form field script
    var textarea = $('#id_script');
    editor.setValue(textarea.val(), -1); // -1 is at the document start
    //console.log(textarea.val());
    editor.session.getUndoManager().markClean();
    
    //$('#submit-id-submit').on('click', function() {
    $("input[id^='submit-id']").on('click', function() {
        var editor_content = editor.getSession().getValue();
    	textarea.val(editor_content);
    });

    ///////////////////////////////////////////////////////////////////////////
    // DataTable with the runs

    // Setting up jQuery to pass csrf tokens to Django when using ajax.
	$.ajaxSetup({
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}'
        }
    });

    // set Instruments field
    function setDataTableContent() {
        $.ajax({
            url : "{% url 'catalog:list_runs_ajax_table' ipts=user.profile.ipts %}",
            type : 'get',
            dataType : 'json',
            success : function(data) {
                $("#tableruns").DataTable().destroy();
                $('#tableruns').empty(); // empty in case the columns change

                var table = $("#tableruns").DataTable(
                    {
                        data: data,
                        lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "All"]],
                        paging: true,
                        lengthChange: true,
                        searching: true,
                        ordering: true,
                        info: true,
                        //autoWidth: true,
                        //stateSave: true, // saves
                        columns: [
                            { title: "Run" },
                            { title: "Title" },
                            { title: "Location" }
                        ],
                        columnDefs: [
                            {
                                targets: 2,
                                visible: false,
                                searchable: false
                            }
                        ],
                        select: {
                            style:    'os' //complex behaviours such as ctrl/cmd clicking to select / deselect individual items, shift clicking to select ranges and an unmodified click to select a single item.
                            //style:    'multi',
                            //selector: 'td:first-child'
                        },
                        order: [[ 0, 'asc' ]]
                    }
                );
                
                // see if there's any selected elements in the form
                var parameters = JSON.parse($("#id_parameters").val());
                if (parameters != null && parameters.length > 0){
                    // Add the selected elements in the form to the table
                    var tableData = table.data().toArray();
                    tableData.forEach(function(element, i) {
                        parameters.forEach(function(param) {
                            if (element[0] == param[0]){
                                table.rows(i).select();
                            }
                        });
                    });
                }

                $(".loader").hide();
                $('#runsModal').modal('show');
            },
            error: function () {
                $.notify("Error fetching catalog runs data...", "error");
                $(".loader").hide();
            }
        });
    }
    
    function showDataTable(){
        $(".loader").show();
        setDataTableContent();        
    }

    // pick the select runs from the model and sets the form field parameters
    function pickSelectedRuns(){
        var table = $("#tableruns").DataTable();
        $('#id_parameters').val(JSON.stringify(table.rows( { selected: true } ).data().toArray()));
        $('#runsModal').modal('hide');
    }

    function selectRunsAll(){
        var table = $("#tableruns").DataTable();
        table.rows({ search: 'applied' }).select();
    }

    function selectRunsNone(){
        var table = $("#tableruns").DataTable();
        table.rows().deselect();
    }

    ///////////////////////////////////////////////////////////////////////////
    // Select Action
    function handleCompVisability(){
        
        if ($("#id_action").val() == ""){
            $("#button_pick_runs").hide();
            $("#button_generate").hide();
            $("#button_save").hide();
            $("#button_execute").hide();

            $("#div_id_parameters").hide();
            $("#div_id_script").hide();
        } else {
            var actionsText = $("#id_action option:selected").text();
            var runs = $("#id_parameters").val();
            var script = $("#id_script").val();

            if ( actionsText.toLowerCase().indexOf("execute") >= 0 ){
                console.log("Execute");
                $("#div_id_script").hide();
                $("#button_pick_runs").show();
                if (runs.length > 10){
                    $("#button_generate").show();
                }
                else{
                    $("#button_generate").hide();
                }

            } else { // auto reduction
                console.log("Auto reduction");
                $("#button_pick_runs").hide();
                $("#div_id_parameters").hide();
                $("#button_generate").show();
            }
    
            if (script.length > 10) {
                $("#div_id_script").show();
                $("#button_save").show();
                $("#button_execute").show();
            } else {
                $("#div_id_script").hide();
                $("#button_save").hide();
                $("#button_execute").hide();
            }
        }
    }

    function init(){
        // The user cannot change the runs
        $("#id_parameters").prop('readonly', true);

        // Add action to the select box
        $("#id_action").on("change", function() { 
            handleCompVisability();
        });
        handleCompVisability();
    }

    $( document ).ready(function() {
        init();
    });
    
</script>
{% endblock %}
